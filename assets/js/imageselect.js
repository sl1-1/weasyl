!function(e){function t(){return e("<div/>")}var o=Math.abs,i=Math.max,n=Math.min,s=Math.round;e.imgAreaSelect=function(d,r){function a(e){return e+be.left-ge.left}function c(e){return e+be.top-ge.top}function l(e){return e-be.left+ge.left}function u(e){return e-be.top+ge.top}function h(e){return e.pageX-ge.left}function f(e){return e.pageY-ge.top}function m(e){var t=e||Q,o=e||X;return{x1:s(we.x1*t),y1:s(we.y1*o),x2:s(we.x2*t),y2:s(we.y2*o),width:s(we.x2*t)-s(we.x1*t),height:s(we.y2*o)-s(we.y1*o)}}function p(e,t,o,i,n){var d=n||Q,r=n||X;we={x1:s(e/d||0),y1:s(t/r||0),x2:s(o/d||0),y2:s(i/r||0)},we.width=we.x2-we.x1,we.height=we.y2-we.y1}function y(){E&&ue.width()&&(be={left:s(ue.offset().left),top:s(ue.offset().top)},j=ue.innerWidth(),D=ue.innerHeight(),be.top+=ue.outerHeight()-D>>1,be.left+=ue.outerWidth()-j>>1,F=s(r.minWidth/Q)||0,G=s(r.minHeight/X)||0,J=s(n(r.maxWidth/Q||1<<24,j)),U=s(n(r.maxHeight/X||1<<24,D)),"1.3.2"!=e().jquery||"fixed"!=ve||Se.getBoundingClientRect||(be.top+=i(document.body.scrollTop,Se.scrollTop),be.left+=i(document.body.scrollLeft,Se.scrollLeft)),ge=/absolute|relative/.test($.css("position"))?{left:s($.offset().left)-$.scrollLeft(),top:s($.offset().top)-$.scrollTop()}:"fixed"==ve?{left:e(document).scrollLeft(),top:e(document).scrollTop()}:{left:0,top:0},L=a(0),R=c(0),(we.x2>j||we.y2>D)&&k())}function b(t){if(_){switch(he.css({left:a(we.x1),top:c(we.y1)}).add(fe).width(ae=we.width).height(ce=we.height),fe.add(me).add(ye).css({left:0,top:0}),me.width(i(ae-me.outerWidth()+me.innerWidth(),0)).height(i(ce-me.outerHeight()+me.innerHeight(),0)),e(pe[0]).css({left:L,top:R,width:we.x1,height:D}),e(pe[1]).css({left:L+we.x1,top:R,width:ae,height:we.y1}),e(pe[2]).css({left:L+we.x2,top:R,width:j-we.x2,height:D}),e(pe[3]).css({left:L+we.x1,top:R+we.y2,width:ae,height:D-we.y2}),ae-=ye.outerWidth(),ce-=ye.outerHeight(),ye.length){case 8:e(ye[4]).css({left:ae>>1}),e(ye[5]).css({left:ae,top:ce>>1}),e(ye[6]).css({left:ae>>1,top:ce}),e(ye[7]).css({top:ce>>1});case 4:ye.slice(1,3).css({left:ae}),ye.slice(2,4).css({top:ce})}t!==!1&&(e.imgAreaSelect.onKeyPress!=ke&&e(document).unbind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress),r.keys&&e(document)[e.imgAreaSelect.keyPress](e.imgAreaSelect.onKeyPress=ke)),Ae&&me.outerWidth()-me.innerWidth()==2&&(me.css("margin",0),setTimeout(function(){me.css("margin","auto")},0))}}function g(e){y(),b(e),ee=a(we.x1),te=c(we.y1),oe=a(we.x2),ie=c(we.y2)}function x(e,t){r.fadeSpeed?e.fadeOut(r.fadeSpeed,t):e.hide()}function v(e){var t=l(h(e))-we.x1,o=u(f(e))-we.y1;le||(y(),le=!0,he.one("mouseout",function(){le=!1})),Y="",r.resizable&&(o<=r.resizeMargin?Y="n":o>=we.height-r.resizeMargin&&(Y="s"),t<=r.resizeMargin?Y+="w":t>=we.width-r.resizeMargin&&(Y+="e")),he.css("cursor",Y?Y+"-resize":r.movable?"move":""),T&&T.toggle()}function w(t){e("body").css("cursor",""),(r.autoHide||we.width*we.height==0)&&x(he.add(pe),function(){e(this).hide()}),e(document).unbind("mousemove",A),he.mousemove(v),r.onSelectEnd(d,m())}function S(t){return 1!=t.which?!1:(y(),Y?(e("body").css("cursor",Y+"-resize"),ee=a(we[/w/.test(Y)?"x2":"x1"]),te=c(we[/n/.test(Y)?"y2":"y1"]),e(document).mousemove(A).one("mouseup",w),he.unbind("mousemove",v)):r.movable?(q=L+we.x1-h(t),B=R+we.y1-f(t),he.unbind("mousemove",v),e(document).mousemove(W).one("mouseup",function(){r.onSelectEnd(d,m()),e(document).unbind("mousemove",W),he.mousemove(v)})):ue.mousedown(t),!1)}function z(e,t){var d=null==t?V:t;d?e?(oe=i(L,n(L+j,ee+o(ie-te)*d*(oe>ee||-1))),ie=s(i(R,n(R+D,te+o(oe-ee)/d*(ie>te||-1)))),oe=s(oe)):(ie=i(R,n(R+D,te+o(oe-ee)/d*(ie>te||-1))),oe=s(i(L,n(L+j,ee+o(ie-te)*d*(oe>ee||-1)))),ie=s(ie)):Z&&(o(oe-ee)>Z*o(ie-te)?(oe=i(L,n(L+j,ee+o(ie-te)*Z*(oe>ee||-1))),oe=s(oe)):o(ie-te)>Z*o(oe-ee)&&(ie=i(R,n(R+D,te+o(oe-ee)*Z*(ie>te||-1)))))}function k(e){ee=n(ee,L+j),te=n(te,R+D),o(oe-ee)<F&&(oe=ee-F*(ee>oe||-1),L>oe?ee=L+F:oe>L+j&&(ee=L+j-F)),o(ie-te)<G&&(ie=te-G*(te>ie||-1),R>ie?te=R+G:ie>R+D&&(te=R+D-G)),oe=i(L,n(oe,L+j)),ie=i(R,n(ie,R+D)),z(o(oe-ee)<o(ie-te)*V,e?1:null),o(oe-ee)>J&&(oe=ee-J*(ee>oe||-1),z(!1,e?1:null)),o(ie-te)>U&&(ie=te-U*(te>ie||-1),z(!0,e?1:null)),we={x1:l(n(ee,oe)),x2:l(i(ee,oe)),y1:u(n(te,ie)),y2:u(i(te,ie)),width:o(oe-ee),height:o(ie-te)},b(),r.onSelectChange(d,m())}function A(e){return oe=/w|e|^$/.test(Y)||V?h(e):a(we.x2),ie=/n|s|^$/.test(Y)||V?f(e):c(we.y2),k(e.shiftKey),!1}function C(t,o){oe=(ee=t)+we.width,ie=(te=o)+we.height,e.extend(we,{x1:l(ee),y1:u(te),x2:l(oe),y2:u(ie)}),b(),r.onSelectChange(d,m())}function W(e){return ee=i(L,n(q+h(e),L+j-we.width)),te=i(R,n(B+f(e),R+D-we.height)),C(ee,te),e.preventDefault(),!1}function K(){e(document).unbind("mousemove",K),y(),oe=ee,ie=te,k(),Y="",pe.is(":visible")||he.add(pe).hide().fadeIn(r.fadeSpeed||0),_=!0,e(document).unbind("mouseup",I).mousemove(A).one("mouseup",w),he.unbind("mousemove",v),r.onSelectStart(d,m())}function I(){e(document).unbind("mousemove",K).unbind("mouseup",I),x(he.add(pe)),p(l(ee),u(te),l(ee),u(te)),this instanceof e.imgAreaSelect||(r.onSelectChange(d,m()),r.onSelectEnd(d,m()))}function P(t){return 1!=t.which||pe.is(":animated")?!1:(y(),q=ee=h(t),B=te=f(t),e(document).mousemove(K).mouseup(I),!1)}function N(){g(!1)}function H(){E=!0,O(r=e.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},r)),he.add(pe).css({visibility:""}),r.show&&(_=!0,y(),b(),he.add(pe).hide().fadeIn(r.fadeSpeed||0)),setTimeout(function(){r.onInit(d,m())},0)}function M(e,t){for(var o in t)void 0!==r[o]&&e.css(t[o],r[o])}function O(o){if(o.parent&&($=e(o.parent)).append(he).append(pe),e.extend(r,o),y(),null!=o.handles){for(ye.remove(),ye=e([]),de=o.handles?"corners"==o.handles?4:8:0;de--;)ye=ye.add(t());ye.addClass(r.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:xe+1||1}),!parseInt(ye.css("width"))>=0&&ye.width(5).height(5),(re=r.borderWidth)&&ye.css({borderWidth:re,borderStyle:"solid"}),M(ye,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}for(Q=r.imageWidth/j||1,X=r.imageHeight/D||1,null!=o.x1&&(p(o.x1,o.y1,o.x2,o.y2),o.show=!o.hide),o.keys&&(r.keys=e.extend({shift:1,ctrl:"resize"},o.keys)),pe.addClass(r.classPrefix+"-outer"),fe.addClass(r.classPrefix+"-selection"),de=0;de++<4;)e(me[de-1]).addClass(r.classPrefix+"-border"+de);M(fe,{selectionColor:"background-color",selectionOpacity:"opacity"}),M(me,{borderOpacity:"opacity",borderWidth:"border-width"}),M(pe,{outerColor:"background-color",outerOpacity:"opacity"}),(re=r.borderColor1)&&e(me[0]).css({borderStyle:"solid",borderColor:re}),(re=r.borderColor2)&&e(me[1]).css({borderStyle:"dashed",borderColor:re}),he.append(fe.add(me).add(T)).append(ye),Ae&&((re=(pe.css("filter")||"").match(/opacity=(\d+)/))&&pe.css("opacity",re[1]/100),(re=(me.css("filter")||"").match(/opacity=(\d+)/))&&me.css("opacity",re[1]/100)),o.hide?x(he.add(pe)):o.show&&E&&(_=!0,he.add(pe).fadeIn(r.fadeSpeed||0),g()),V=(se=(r.aspectRatio||"").split(/:/))[0]/se[1],V||(Z=se=r.maxAspectRatio||""),ue.add(pe).unbind("mousedown",P),r.disable||r.enable===!1?(he.unbind("mousemove",v).unbind("mousedown",S),e(window).unbind("resize",N)):((r.enable||r.disable===!1)&&((r.resizable||r.movable)&&he.mousemove(v).mousedown(S),e(window).resize(N)),r.persistent||ue.add(pe).mousedown(P)),r.enable=r.disable=void 0}var E,T,L,R,j,D,$,q,B,Q,X,Y,F,G,J,U,V,Z,_,ee,te,oe,ie,ne,se,de,re,ae,ce,le,ue=e(d),he=t(),fe=t(),me=t().add(t()).add(t()).add(t()),pe=t().add(t()).add(t()).add(t()),ye=e([]),be={left:0,top:0},ge={left:0,top:0},xe=0,ve="absolute",we={x1:0,y1:0,x2:0,y2:0,width:0,height:0},Se=document.documentElement,ze=navigator.userAgent,ke=function(e){var t,o,s=r.keys,d=e.keyCode;if(t=isNaN(s.alt)||!e.altKey&&!e.originalEvent.altKey?!isNaN(s.ctrl)&&e.ctrlKey?s.ctrl:!isNaN(s.shift)&&e.shiftKey?s.shift:isNaN(s.arrows)?10:s.arrows:s.alt,"resize"==s.arrows||"resize"==s.shift&&e.shiftKey||"resize"==s.ctrl&&e.ctrlKey||"resize"==s.alt&&(e.altKey||e.originalEvent.altKey)){switch(d){case 37:t=-t;case 39:o=i(ee,oe),ee=n(ee,oe),oe=i(o+t,ee),z();break;case 38:t=-t;case 40:o=i(te,ie),te=n(te,ie),ie=i(o+t,te),z(!0);break;default:return}k()}else switch(ee=n(ee,oe),te=n(te,ie),d){case 37:C(i(ee-t,L),te);break;case 38:C(ee,i(te-t,R));break;case 39:C(ee+n(t,j-l(oe)),te);break;case 40:C(ee,te+n(t,D-u(ie)));break;default:return}return!1};this.remove=function(){O({disable:!0}),he.add(pe).remove()},this.getOptions=function(){return r},this.setOptions=O,this.getSelection=m,this.setSelection=p,this.cancelSelection=I,this.update=g;var Ae=(/msie ([\w.]+)/i.exec(ze)||[])[1],Ce=/opera/i.test(ze),We=/webkit/i.test(ze)&&!/chrome/i.test(ze);for(ne=ue;ne.length;)xe=i(xe,isNaN(ne.css("z-index"))?xe:ne.css("z-index")),"fixed"==ne.css("position")&&(ve="fixed"),ne=ne.parent(":not(body)");xe=r.zIndex||xe,Ae&&ue.attr("unselectable","on"),e.imgAreaSelect.keyPress=Ae||We?"keydown":"keypress",Ce&&(T=t().css({width:"100%",height:"100%",position:"absolute",zIndex:xe+2||2})),he.add(pe).css({visibility:"hidden",position:ve,overflow:"hidden",zIndex:xe||"0"}),he.css({zIndex:xe+2||2}),fe.add(me).css({position:"absolute",fontSize:0}),d.complete||"complete"==d.readyState||!ue.is("img")?H():ue.one("load",H),!E&&Ae&&Ae>=7&&(d.src=d.src)},e.fn.imgAreaSelect=function(t){return t=t||{},this.each(function(){e(this).data("imgAreaSelect")?t.remove?(e(this).data("imgAreaSelect").remove(),e(this).removeData("imgAreaSelect")):e(this).data("imgAreaSelect").setOptions(t):t.remove||(void 0===t.enable&&void 0===t.disable&&(t.enable=!0),e(this).data("imgAreaSelect",new e.imgAreaSelect(this,t)))}),t.instance?e(this).data("imgAreaSelect"):this}}(jQuery);